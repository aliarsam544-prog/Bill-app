<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Modern Bill Management App</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4f46e5"/>
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link rel="manifest" href="manifest.json">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- ▼▼▼ تمام CSS کوڈ یہاں موجود ہے ▼▼▼ -->
    <style>
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/websitebeaver/Jameel-Noori-Nastaleeq-Font/jameel-noori-nastaleeq-regular.ttf') format('truetype');
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', 'Jameel Noori Nastaleeq', sans-serif; background-color: #f1f5f9; }
        .urdu { font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif; direction: rtl; font-size: 1.0rem; line-height: 1.8; }
        .urdu-input { font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif; }
        .latin-input { font-family: 'Inter', sans-serif; direction: ltr; }
        .card { background-color: white; border-radius: 1.25rem; padding: 1.25rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .card-title { font-weight: 700; color: #1e293b; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0; margin-bottom: 1rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; padding: 0.75rem; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .input-error { border-color: #ef4444 !important; box-shadow: 0 0 0 2px #fecaca !important; }
        
        html, body { height: auto; margin: 0; padding: 0; }
        #app-container { display: flex; flex-direction: column; min-height: 100vh; }
        .main-content { flex-grow: 1; padding: 0.75rem; }
        .action-footer { flex-shrink: 0; padding: 0.75rem; background-color: #f1f5f9; box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1); position: sticky; bottom: 0; z-index: 20; }

        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #2c3e50; color: white; padding: 10px 20px; border-radius: 25px; z-index: 1000; opacity: 0; transition: opacity 0.5s, bottom 0.5s; font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif; font-size: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; bottom: 40px; }

        .summary-table { width: 100%; border-collapse: collapse; }
        .summary-table th, .summary-table td { padding: 0.5rem; text-align: right; border-bottom: 1px solid #e2e8f0; }
        .summary-table thead th { background-color: #f8fafc; font-weight: 600; color: #475569; position: sticky; top: 0; z-index: 10; }
        .summary-table tbody tr:hover { background-color: #f8fafc; }
        .summary-table td input { padding: 0.5rem; }
        #sub-meters-container { border: 1px solid #e2e8f0; border-radius: 0.75rem; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="app-container" class="max-w-4xl mx-auto">
        <header class="text-center py-3 px-4 flex-shrink-0">
            <h1 class="text-2xl sm:text-4xl font-bold text-slate-800 urdu">بل مینجمنٹ سسٹم</h1>
            <p class="text-slate-500 mt-1 urdu text-sm sm:text-base">حساب لگائیں، محفوظ کریں اور بل بھیجیں</p>
            <div class="mt-2">
                <button id="view-history-btn" class="inline-flex items-center gap-2 bg-white text-slate-700 py-1.5 px-4 rounded-full shadow hover:bg-slate-50 urdu transition-colors text-sm">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                    بل کی ہسٹری دیکھیں
                </button>
            </div>
        </header>
        
        <main class="main-content space-y-5">
            <div id="error-container" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded-lg urdu text-sm"></div>
            
            <section class="card space-y-5">
                <h2 class="card-title urdu text-lg sm:text-xl md:text-2xl">بل اور ریڈنگ کی تفصیلات</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-5 gap-y-3 text-sm">
                    <div class="md:col-span-2 grid grid-cols-2 gap-3 p-3 bg-slate-50 rounded-lg">
                        <div>
                            <label for="billing-month" class="block font-medium text-slate-600 urdu">بلنگ مہینہ</label>
                            <select id="billing-month" class="mt-1 block w-full rounded-md p-2 urdu border-slate-300 shadow-sm"></select>
                        </div>
                        <div>
                            <label for="billing-year" class="block font-medium text-slate-600 urdu">سال</label>
                            <input type="number" id="billing-year" class="mt-1 block w-full rounded-md p-2 latin-input text-right border-slate-300 shadow-sm" placeholder="2024">
                        </div>
                    </div>
                    <div>
                        <label for="main-prev-units" class="block font-medium text-slate-600 urdu">مین میٹر پچھلی ریڈنگ</label>
                        <input type="number" id="main-prev-units" min="0" class="mt-1 block w-full rounded-md p-2 latin-input text-right border-slate-300">
                    </div>
                    <div>
                        <label for="main-curr-units" class="block font-medium text-slate-600 urdu">مین میٹر موجودہ ریڈنگ</label>
                        <input type="number" id="main-curr-units" min="0" class="mt-1 block w-full rounded-md p-2 latin-input text-right border-slate-300" readonly>
                    </div>
                    <div class="md:col-span-2">
                        <label for="total-bill-amount" class="block font-medium text-slate-600 urdu">کُل بل کی رقم (PKR)</label>
                        <input type="number" id="total-bill-amount" min="0" class="mt-1 block w-full rounded-md p-2 latin-input text-right border-slate-300">
                    </div>
                </div>
                <h3 class="text-base sm:text-lg font-semibold text-slate-700 urdu border-t pt-4">سب میٹرز کا خلاصہ</h3>
                <div id="sub-meters-container">
                    <div id="sub-meters-list"></div>
                </div>
            </section>
            
            <section class="card !p-0">
                <details>
                    <summary class="card-title !border-b-0 !mb-0 !p-5 sm:!p-6 flex justify-between items-center cursor-pointer text-lg sm:text-xl md:text-2xl">
                        <span class="urdu">ایڈوانس سیٹنگز</span>
                        <svg class="h-5 w-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div class="p-5 sm:p-6 border-t space-y-5 text-sm">
                        <div>
                            <h4 class="text-base font-semibold text-slate-700 urdu mb-3">میٹر مینجمنٹ</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end mb-3">
                                <div>
                                    <label for="new-meter-name" class="block font-medium text-slate-600 urdu">نئے میٹر کا نام</label>
                                    <input type="text" id="new-meter-name" class="mt-1 block w-full rounded-md p-2 urdu urdu-input text-right border-slate-300">
                                </div>
                                <div>
                                    <label for="new-meter-phone" class="block font-medium text-slate-600 urdu">واٹس ایپ نمبر</label>
                                    <input type="tel" id="new-meter-phone" pattern="[0-9]*" class="mt-1 block w-full rounded-md p-2 latin-input text-right border-slate-300" placeholder="e.g., 3001234567">
                                </div>
                                <div class="md:col-span-2">
                                    <button id="add-new-meter-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md shadow hover:bg-indigo-700 urdu">نیا میٹر شامل کریں</button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-5 pt-5 border-t">
                            <h4 class="text-base font-semibold text-slate-700 urdu mb-3">ڈیٹا بیک اپ</h4>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <button id="export-data-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 urdu">بیک اپ بنائیں (Export)</button>
                                <button id="import-data-btn" class="w-full bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 urdu">بیک اپ ری اسٹور کریں (Import)</button>
                                <input type="file" id="import-file-input" class="hidden" accept=".json">
                            </div>
                        </div>
                        <div class="mt-5 pt-5 border-t text-right">
                             <h4 class="text-base font-semibold text-slate-700 urdu mb-3">ایپ ری سیٹ</h4>
                            <button id="reset-app-btn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 urdu">تمام ڈیٹا حذف کریں</button>
                        </div>
                    </div>
                </details>
            </section>
        </main>
        
        <footer class="action-footer text-center">
            <button id="calculate-btn" class="w-full md:w-auto bg-indigo-600 text-white py-2.5 px-10 rounded-full shadow-xl hover:bg-indigo-700 text-base sm:text-lg font-bold urdu transform hover:scale-105 transition-transform">بل تقسیم کریں</button>
            <p class="text-xs text-slate-500 mt-2" style="direction: ltr; font-family: 'Inter', sans-serif;">Developed by Irfan Ilahi</p>
        </footer>
    </div>
    
    <div id="results-modal" class="modal-overlay"></div>
    <div id="edit-modal" class="modal-overlay"></div>
    <div id="history-modal" class="modal-overlay"></div>
    <div id="preview-modal" class="modal-overlay"></div>

    <!-- ▼▼▼ تمام JavaScript کوڈ یہاں موجود ہے ▼▼▼ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const METER_STORAGE_KEY = 'billManagementSystem_Meters_v23_final';
            const HISTORY_STORAGE_KEY = 'billManagementSystem_History_v23_final';
            const LAST_BILL_DATE_KEY = 'billManagementSystem_LastBillDate_v23_final';
            const dom = {};
            
            function initializeApp() {
                Object.assign(dom, {
                    errorContainer: document.getElementById('error-container'),
                    mainInputs: {
                        prev: document.getElementById('main-prev-units'),
                        curr: document.getElementById('main-curr-units'),
                        bill: document.getElementById('total-bill-amount'),
                        month: document.getElementById('billing-month'),
                        year: document.getElementById('billing-year')
                    },
                    subMetersList: document.getElementById('sub-meters-list'),
                    calculateBtn: document.getElementById('calculate-btn'),
                    viewHistoryBtn: document.getElementById('view-history-btn'),
                    resultsModal: document.getElementById('results-modal'),
                    meterManagement: {
                        addBtn: document.getElementById('add-new-meter-btn'),
                        nameInput: document.getElementById('new-meter-name'),
                        phoneInput: document.getElementById('new-meter-phone'),
                        resetBtn: document.getElementById('reset-app-btn'),
                        exportBtn: document.getElementById('export-data-btn'),
                        importBtn: document.getElementById('import-data-btn'),
                        importInput: document.getElementById('import-file-input')
                    },
                    editModal: document.getElementById('edit-modal'),
                    historyModal: document.getElementById('history-modal'),
                    previewModal: document.getElementById('preview-modal')
                });
                attachEventListeners();
                setInitialDate();
                loadMeters();
                initializeModals();
                registerServiceWorker();
            }

            function registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('./service-worker.js')
                            .then(registration => {
                                console.log('ServiceWorker registration successful with scope: ', registration.scope);
                            })
                            .catch(err => {
                                console.log('ServiceWorker registration failed: ', err);
                            });
                    });
                }
            }
            
            const getMeters = () => JSON.parse(localStorage.getItem(METER_STORAGE_KEY) || '[]');
            const saveMeters = (meters) => localStorage.setItem(METER_STORAGE_KEY, JSON.stringify(meters));
            const getHistory = () => JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');
            const saveHistory = (history) => localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
            const formatPhoneNumber = (phone) => {
                if (!phone) return '';
                let c = ('' + phone).replace(/\D/g, '');
                if (c.length === 10 && c.startsWith('3')) return '92' + c;
                if (c.length === 12 && c.startsWith('92')) return c;
                return phone;
            };
            
            const showError = (message, el = null) => {
                dom.errorContainer.innerHTML = `<p>${message}</p>`;
                dom.errorContainer.classList.remove('hidden');
                document.documentElement.scrollTo({ top: 0, behavior: 'smooth' });
                if (el) {
                    el.classList.add('input-error');
                    el.focus();
                }
            };
            
            const clearError = () => {
                dom.errorContainer.classList.add('hidden');
                document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            };
            
            function showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => document.body.removeChild(toast), 500);
                }, 3000);
            }
            
            function attachEventListeners() {
                dom.calculateBtn.addEventListener('click', performCalculation);
                dom.viewHistoryBtn.addEventListener('click', openHistoryModal);
                dom.meterManagement.addBtn.addEventListener('click', addMeter);
                dom.meterManagement.resetBtn.addEventListener('click', resetApp);
                dom.meterManagement.exportBtn.addEventListener('click', exportData);
                dom.meterManagement.importBtn.addEventListener('click', () => dom.meterManagement.importInput.click());
                dom.meterManagement.importInput.addEventListener('change', importData);

                dom.subMetersList.addEventListener('click', (e) => {
                    if (e.target.closest('.edit-meter-btn')) openEditModal(e.target.closest('.edit-meter-btn').dataset.id);
                });
                dom.subMetersList.addEventListener('input', (e) => {
                    if (e.target.classList.contains('sub-curr-units') || e.target.classList.contains('sub-prev-units')) {
                        updateConsumedUnits(e.target);
                    }
                });
                dom.subMetersList.addEventListener('blur', (e) => {
                    if (e.target.classList.contains('sub-prev-units')) {
                        savePreviousReading(e.target);
                    }
                }, true);
                dom.mainInputs.prev.addEventListener('input', updateMainMeterTotal);
            }

            function exportData() {
                try {
                    const data = {
                        meters: getMeters(),
                        history: getHistory(),
                        lastBillDate: localStorage.getItem(LAST_BILL_DATE_KEY)
                    };
                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const date = new Date().toISOString().slice(0, 10);
                    a.download = `bill_management_backup_${date}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('ڈیٹا بیک اپ کامیابی سے بنا لیا گیا۔');
                } catch (error) {
                    console.error('Export failed:', error);
                    showError('ڈیٹا ایکسپورٹ کرنے میں خرابی ہوئی۔');
                }
            }

            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!confirm('کیا آپ واقعی بیک اپ ری اسٹور کرنا چاہتے ہیں؟ موجودہ تمام ڈیٹا حذف ہو جائے گا۔')) {
                    event.target.value = ''; // Reset file input
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data && data.meters && data.history) {
                            saveMeters(data.meters);
                            saveHistory(data.history);
                            if(data.lastBillDate) {
                                localStorage.setItem(LAST_BILL_DATE_KEY, data.lastBillDate);
                            } else {
                                localStorage.removeItem(LAST_BILL_DATE_KEY);
                            }
                            
                            loadMeters();
                            setInitialDate();
                            showToast('بیک اپ کامیابی سے ری اسٹور ہو گیا۔');
                        } else {
                            throw new Error('Invalid backup file format.');
                        }
                    } catch (error) {
                        console.error('Import failed:', error);
                        showError('بیک اپ فائل خراب ہے یا فارمیٹ غلط ہے۔');
                    } finally {
                        event.target.value = ''; // Reset file input
                    }
                };
                reader.readAsText(file);
            }
            
            function updateConsumedUnits(inputElement) {
                const row = inputElement.closest('tr');
                if (!row) return;
                const prevReading = parseFloat(row.querySelector('.sub-prev-units').value) || 0;
                const currReading = parseFloat(row.querySelector('.sub-curr-units').value) || 0;
                const consumedCell = row.querySelector('.consumed-units');
                if (currReading >= prevReading) {
                    consumedCell.textContent = (currReading - prevReading).toFixed(2);
                    consumedCell.classList.remove('text-red-500', 'font-bold');
                } else if (inputElement.value.trim() !== '') {
                    consumedCell.textContent = 'غلط';
                    consumedCell.classList.add('text-red-500', 'font-bold');
                } else {
                    consumedCell.textContent = '0.00';
                    consumedCell.classList.remove('text-red-500', 'font-bold');
                }
                updateMainMeterTotal();
            }
            
            function savePreviousReading(inputElement) {
                const row = inputElement.closest('tr');
                if (!row) return;
                const meterId = parseInt(row.dataset.meterId, 10);
                const newPrevReading = parseFloat(inputElement.value);
                if (isNaN(newPrevReading) || newPrevReading < 0) return;
                const meters = getMeters();
                const meterIndex = meters.findIndex(m => m.id === meterId);
                if (meterIndex > -1) {
                    if (meters[meterIndex].lastReading !== newPrevReading) {
                        meters[meterIndex].lastReading = newPrevReading;
                        saveMeters(meters);
                        showToast(`"${meters[meterIndex].name}" کی پچھلی ریڈنگ محفوظ ہو گئی۔`);
                    }
                }
            }
            
            function updateMainMeterTotal() {
                let totalSubConsumed = 0;
                document.querySelectorAll('.consumed-units').forEach(cell => {
                    const consumed = parseFloat(cell.textContent);
                    if (!isNaN(consumed)) totalSubConsumed += consumed;
                });
                const mainPrev = parseFloat(dom.mainInputs.prev.value) || 0;
                const newMainCurr = mainPrev + totalSubConsumed;
                dom.mainInputs.curr.value = totalSubConsumed > 0 ? newMainCurr.toFixed(2) : '';
            }
            
            function setInitialDate() {
                const months = ["جنوری", "فروری", "مارچ", "اپریل", "مئی", "جون", "جولائی", "اگست", "ستمبر", "اکتوبر", "نومبر", "دسمبر"];
                if (dom.mainInputs.month.options.length === 0) {
                    months.forEach((month, index) => dom.mainInputs.month.add(new Option(month, index)));
                }
                const lastBillDateStr = localStorage.getItem(LAST_BILL_DATE_KEY);
                let nextDate;
                if (lastBillDateStr) {
                    const lastDate = new Date(lastBillDateStr);
                    nextDate = new Date(lastDate.getFullYear(), lastDate.getMonth() + 1, 1);
                } else {
                    const now = new Date();
                    nextDate = new Date(now.getFullYear(), now.getMonth(), 1);
                }
                dom.mainInputs.month.value = nextDate.getMonth();
                dom.mainInputs.year.value = nextDate.getFullYear();
            }
            
            function loadMeters() {
                const meters = getMeters();
                if (meters.length === 0) {
                    dom.subMetersList.innerHTML = `<p class="text-center text-slate-500 urdu p-4">کوئی میٹر محفوظ نہیں۔ "ایڈوانس سیٹنگز" سے نیا میٹر شامل کریں۔</p>`;
                    updateMainMeterTotal();
                    return;
                }
                const tableRows = meters.map(meter => `<tr data-meter-id="${meter.id}" class="urdu">
                    <td class="whitespace-nowrap">${meter.name}<button class="edit-meter-btn p-1 text-slate-400 hover:text-indigo-600 align-middle" data-id="${meter.id}" title="ترمیم کریں"><svg class="h-4 w-4 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a1 1 0 011-1h9a1 1 0 110 2H7v5a1 1 0 01-2 0z"/></svg></button></td>
                    <td><input type="number" value="${meter.lastReading || 0}" class="sub-prev-units block w-full rounded-md p-2 latin-input text-right border-slate-300"></td>
                    <td><input type="number" min="${meter.lastReading || 0}" class="sub-curr-units block w-full rounded-md p-2 latin-input text-right border-slate-300" placeholder="...نئی ریڈنگ"></td>
                    <td class="consumed-units text-center latin-input font-medium text-slate-700">0.00</td>
                </tr>`).join('');
                dom.subMetersList.innerHTML = `<table class="summary-table urdu"><thead><tr><th>میٹر کا نام</th><th class="text-center">پچھلی ریڈنگ</th><th class="text-center">موجودہ ریڈنگ</th><th class="text-center">استعمال شدہ یونٹس</th></tr></thead><tbody>${tableRows}</tbody></table>`;
                updateMainMeterTotal();
            }
            
            function addMeter() {
                clearError();
                const name = dom.meterManagement.nameInput.value.trim();
                const phone = dom.meterManagement.phoneInput.value.trim();
                if (!name) return showError('براہ کرم میٹر کا نام درج کریں۔', dom.meterManagement.nameInput);
                const meters = getMeters();
                if (meters.some(m => m.name === name)) return showError('اس نام کا میٹر پہلے سے موجود ہے۔', dom.meterManagement.nameInput);
                meters.push({
                    id: Date.now(),
                    name,
                    phone: phone || '',
                    lastReading: 0
                });
                saveMeters(meters);
                loadMeters();
                dom.meterManagement.nameInput.value = '';
                dom.meterManagement.phoneInput.value = '';
                document.querySelector('details').removeAttribute('open');
                showToast('میٹر کامیابی سے شامل ہو گیا۔');
            }
            
            function resetApp() {
                if (confirm('کیا آپ واقعی تمام محفوظ شدہ میٹرز اور ہسٹری کو حذف کرنا چاہتے ہیں؟')) {
                    localStorage.removeItem(METER_STORAGE_KEY);
                    localStorage.removeItem(HISTORY_STORAGE_KEY);
                    localStorage.removeItem(LAST_BILL_DATE_KEY);
                    loadMeters();
                    setInitialDate();
                    clearError();
                    showToast('ایپ ری سیٹ ہو گئی ہے۔');
                }
            }
            
            function performCalculation() {
                clearError();
                let hasError = false;
                const monthIndex = dom.mainInputs.month.value,
                      monthName = dom.mainInputs.month.options[monthIndex].text,
                      year = dom.mainInputs.year.value;
                if (!year || year < 2000) return showError('براہ کرم درست سال درج کریں۔', dom.mainInputs.year);
                const billingPeriod = `${monthName} ${year}`;
                const mainPrev = parseFloat(dom.mainInputs.prev.value),
                      mainCurr = parseFloat(dom.mainInputs.curr.value),
                      totalBill = parseFloat(dom.mainInputs.bill.value);
                if (isNaN(mainPrev) || mainPrev < 0) return showError('مین میٹر کی پچھلی ریڈنگ درج کریں۔', dom.mainInputs.prev);
                if (isNaN(mainCurr) || mainCurr <= 0) return showError('مین میٹر کی موجودہ ریڈنگ درست نہیں ہے۔ سب میٹرز کی ریڈنگ چیک کریں۔', dom.mainInputs.curr);
                if (isNaN(totalBill) || totalBill <= 0) return showError('کل بل کی رقم درج کریں۔', dom.mainInputs.bill);
                if (mainCurr < mainPrev) return showError('مین میٹر کی موجودہ ریڈنگ پچھلی سے کم نہیں ہو سکتی۔', dom.mainInputs.curr);
                let totalSubConsumed = 0;
                const subMetersData = [];
                document.querySelectorAll('#sub-meters-list tbody tr').forEach(row => {
                    if(hasError) return;
                    const currInput = row.querySelector('.sub-curr-units'),
                          prevInput = row.querySelector('.sub-prev-units');
                    const name = row.querySelector('td:first-child').textContent.trim();
                    const prevUnits = parseFloat(prevInput.value),
                          currUnits = parseFloat(currInput.value);
                    if (isNaN(currUnits) || currUnits < 0) {
                        hasError = true;
                        return showError(`'${name}' کی موجودہ ریڈنگ خالی ہے۔`, currInput);
                    }
                    if (currUnits < prevUnits) {
                        hasError = true;
                        return showError(`'${name}' کی موجودہ ریڈنگ پچھلی سے کم نہیں ہو سکتی۔`, currInput);
                    }
                    const savedMeter = getMeters().find(m => m.id == row.dataset.meterId) || {};
                    subMetersData.push({
                        ...savedMeter,
                        prevReading: prevUnits,
                        currReading: currUnits,
                        consumedUnits: currUnits - prevUnits,
                        newReading: currUnits
                    });
                    totalSubConsumed += currUnits - prevUnits;
                });
                if(hasError) return;
                if(totalSubConsumed <= 0) return showError('سب میٹرز کے کل استعمال شدہ یونٹس صفر ہیں۔ بل تقسیم نہیں کیا جا سکتا۔');
                const mainConsumed = mainCurr - mainPrev;
                if (Math.abs(totalSubConsumed - mainConsumed) > 1) {
                    if (!confirm(`انتباہ: سب میٹرز کے کل یونٹس (${totalSubConsumed.toFixed(2)}) مین میٹر کے یونٹس (${mainConsumed.toFixed(2)}) سے مختلف ہیں۔\n\nکیا آپ پھر بھی حساب لگانا چاہتے ہیں؟`)) return;
                }
                const perUnitRate = mainConsumed > 0 ? totalBill / mainConsumed : 0;
                const resultsData = {
                    billingPeriod,
                    totalBill,
                    totalMainUnits: mainConsumed,
                    totalSubUnits: totalSubConsumed,
                    perUnitRate,
                    subMeters: subMetersData.map(m => ({...m, amount: m.consumedUnits * perUnitRate}))
                };
                openResultsModal(resultsData);
                saveHistory([
                    {
                        id: Date.now(),
                        calculationDate: new Date().toISOString(),
                        ...resultsData
                    },
                    ...getHistory()
                ]);
                const currentBillDate = new Date(year, monthIndex, 1);
                localStorage.setItem(LAST_BILL_DATE_KEY, currentBillDate.toISOString());
                if (confirm("کیا آپ سب میٹرز کی 'پچھلی ریڈنگ' کو اس مہینے کی 'موجودہ ریڈنگ' سے اپ ڈیٹ کرنا چاہتے ہیں؟")) {
                    saveMeters(getMeters().map(m => {
                        const d = subMetersData.find(d => d.id == m.id);
                        if (d && d.newReading > 0) m.lastReading = d.newReading;
                        return m;
                    }));
                    loadMeters();
                    showToast("میٹرز کی ریڈنگ اپ ڈیٹ ہو گئی۔");
                }
                dom.mainInputs.prev.value = '';
                dom.mainInputs.bill.value = '';
                document.querySelectorAll('.sub-curr-units').forEach(input => {
                    input.value = '';
                    updateConsumedUnits(input);
                });
                setInitialDate();
                dom.mainInputs.prev.focus();
            }

            function openResultsModal(data) {
                const content = `<div class="bg-white rounded-xl shadow-xl p-4 w-full max-w-4xl max-h-[90vh] urdu text-right m-4 flex flex-col overflow-hidden"><div class="flex justify-between items-center border-b pb-3 mb-3"><h2 class="text-xl sm:text-2xl font-bold text-slate-800 urdu">بل کا نتیجہ</h2><button class="close-modal-btn p-2 rounded-full hover:bg-slate-100 text-2xl">&times;</button></div><div class="flex-grow overflow-y-auto pr-2"><h3 class="text-base sm:text-lg text-slate-600 mb-4 urdu text-right font-semibold">بل برائے: ${data.billingPeriod}</h3><div class="p-3 bg-slate-50 rounded-lg urdu text-right space-y-2 mb-4"><div class="flex justify-between text-sm"><span class="text-slate-600">کُل بل:</span><span class="font-bold text-slate-800">Rs. ${data.totalBill.toFixed(2)}</span></div><div class="flex justify-between text-sm"><span class="text-slate-600">مین میٹر یونٹس:</span><span class="font-bold text-slate-800">${data.totalMainUnits.toFixed(2)}</span></div><div class="flex justify-between text-sm"><span class="text-slate-600">فی یونٹ قیمت:</span><span class="font-bold text-green-600">Rs. ${data.perUnitRate.toFixed(3)}</span></div></div><div class="overflow-x-auto"><table class="min-w-full bg-white text-sm"><thead><tr class="urdu text-right"><th class="py-2 px-2">میٹر کا نام</th><th class="py-2 px-2">یونٹس</th><th class="py-2 px-2 text-base">رقم</th><th class="py-2 px-2">کارروائی</th></tr></thead><tbody>${data.subMeters.map(meter => {
                    const finalAmount = meter.amount;
                    const fPhone = formatPhoneNumber(meter.phone);
                    const smsText = generateSingleBillSmsText(data, meter);
                    return `<tr class="urdu text-right border-b border-slate-200">
                        <td class="py-2 px-2">${meter.name}</td>
                        <td class="py-2 px-2 text-center">${meter.consumedUnits.toFixed(2)}</td>
                        <td class="py-2 px-2 text-center font-bold text-indigo-600 text-base">Rs. ${finalAmount.toFixed(0)}</td>
                        <td class="py-2 px-2 text-center">
                            <div class="flex items-center justify-center gap-1 flex-wrap">
                                <button class="share-bill-btn bg-green-100 text-green-700 text-xs py-1 px-2 rounded-full hover:bg-green-200 urdu" data-meter-json='${JSON.stringify(meter)}' data-results-json='${JSON.stringify(data)}'>تصویر</button>
                                <button class="share-text-btn bg-yellow-100 text-yellow-800 text-xs py-1 px-2 rounded-full hover:bg-yellow-200 urdu" data-bill-text="${smsText.replace(/"/g, '&quot;')}">متن</button>
                                <button class="show-preview-btn bg-indigo-100 text-indigo-700 text-xs py-1 px-2 rounded-full hover:bg-indigo-200 urdu" data-meter-json='${JSON.stringify(meter)}' data-results-json='${JSON.stringify(data)}'>پریویو</button>
                                <a href="${fPhone ? `https://wa.me/${fPhone}` : 'javascript:void(0)'}" target="_blank" class="p-1 rounded-full ${fPhone ? 'hover:bg-green-100' : 'opacity-30 cursor-not-allowed'}" title="${fPhone ? 'WhatsApp' : 'نمبر محفوظ نہیں'}">
                                    <svg class="h-4 w-4 text-green-500" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413 0 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.586-1.456l-6.305 1.654z"/></svg>
                                </a>
                            </div>
                        </td>
                    </tr>`;
                }).join('')}</tbody></table></div></div></div>`;
                dom.resultsModal.innerHTML = content;
                dom.resultsModal.classList.add('visible');
                dom.resultsModal.addEventListener('click', (e) => {
                    if (e.target.closest('.close-modal-btn')) {
                        dom.resultsModal.classList.remove('visible');
                        return;
                    }
                    const shareBtn = e.target.closest('.share-bill-btn');
                    const textShareBtn = e.target.closest('.share-text-btn');
                    const previewBtn = e.target.closest('.show-preview-btn');

                    if (shareBtn) {
                        const meterData = JSON.parse(shareBtn.dataset.meterJson);
                        const resultsData = JSON.parse(shareBtn.dataset.resultsJson);
                        shareBillAsImage(generateSingleBillHtml(resultsData, meterData, true), shareBtn, { isHistory: false, results: resultsData, meter: meterData });
                    } else if (textShareBtn) {
                        const billText = textShareBtn.dataset.billText;
                         if (navigator.share) {
                            navigator.share({ title: 'بجلی کا بل', text: billText }).catch(err => console.log(err));
                        } else {
                            navigator.clipboard.writeText(billText).then(() => showToast('بل کا متن کاپی ہو گیا۔'));
                        }
                    } else if (previewBtn) {
                        const meterData = JSON.parse(previewBtn.dataset.meterJson);
                        const resultsData = JSON.parse(previewBtn.dataset.resultsJson);
                        const billHtml = generateSingleBillHtml(resultsData, meterData);
                        openPreviewModal(billHtml, { isHistory: false, results: resultsData, meter: meterData });
                    }
                });
            }

            async function shareBillAsImage(htmlContent, buttonElement, fallbackData) {
                const originalText = buttonElement.innerHTML;
                buttonElement.disabled = true;
                buttonElement.innerHTML = '...';
                
                const tempDiv = document.createElement('div');
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                tempDiv.style.top = '0';
                tempDiv.innerHTML = htmlContent;
                document.body.appendChild(tempDiv);
                
                try {
                    await document.fonts.ready;
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    const canvas = await html2canvas(tempDiv.firstElementChild, { 
                        scale: 2, 
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#f1f5f9',
                        logging: false
                    });
                    
                    const blob = await new Promise((resolve, reject) => {
                        canvas.toBlob(blob => {
                            if (blob) resolve(blob);
                            else reject(new Error('Failed to create blob'));
                        }, 'image/png', 1.0);
                    });
                    
                    const file = new File([blob], 'bill-details.png', { type: 'image/png' });
                    
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({ files: [file], title: 'بجلی کا بل' });
                    } else {
                        await navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ]);
                        showToast('تصویر کلپ بورڈ میں کاپی ہو گئی۔');
                    }
                } catch (error) {
                    console.error('Share as image failed, falling back to text.', error);
                    const { isHistory, record, results, meter } = fallbackData;
                    const fallbackText = isHistory ? (meter ? generateSingleBillSmsText(record, meter) : generateHistorySmsText(record)) : generateSingleBillSmsText(results, meter);
                    if (navigator.share) {
                        await navigator.share({ title: 'بل کی تفصیلات', text: fallbackText });
                    } else {
                        await navigator.clipboard.writeText(fallbackText);
                        showToast('تصویر بنانے میں ناکامی، متن کاپی ہو گیا۔');
                    }
                } finally {
                    if (document.body.contains(tempDiv)) {
                        document.body.removeChild(tempDiv);
                    }
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = originalText;
                }
            }

            function generateSingleBillSmsText(resultsData, meterData) {
                const finalAmount = meterData.amount.toFixed(0);
                return `*بجلی کا بل*\n\n*مہینہ:* ${resultsData.billingPeriod}\n*میٹر:* ${meterData.name}\n\nپچھلی ریڈنگ: ${meterData.prevReading.toFixed(2)}\nموجودہ ریڈنگ: ${meterData.currReading.toFixed(2)}\nاستعمال شدہ یونٹس: ${meterData.consumedUnits.toFixed(2)}\nفی یونٹ قیمت: Rs. ${resultsData.perUnitRate.toFixed(3)}\n\n*کُل قابلِ ادا رقم: Rs. ${finalAmount}*`;
            }

            function generateSingleBillHtml(resultsData, meterData, forImage = false) {
                const containerStyle = forImage ? 'style="width: 420px;"' : '';
                return `<div class="bg-slate-100 p-2 urdu" ${containerStyle}><div class="w-full mx-auto bg-white p-4 rounded-lg shadow-lg"><div class="text-center border-b pb-2 mb-3"><h1 class="text-xl sm:text-2xl font-bold">بجلی کا بل</h1><p class="text-slate-500 text-xs sm:text-sm">${resultsData.billingPeriod}</p></div><div class="mb-3"><h2 class="text-base sm:text-lg font-bold">${meterData.name}</h2></div><table class="w-full text-xs sm:text-sm"><tbody><tr class="border-b"><td class="py-1.5 text-slate-600">پچھلی ریڈنگ</td><td class="py-1.5 text-left font-mono">${meterData.prevReading.toFixed(2)}</td></tr><tr class="border-b"><td class="py-1.5 text-slate-600">موجودہ ریڈنگ</td><td class="py-1.5 text-left font-mono">${meterData.currReading.toFixed(2)}</td></tr><tr class="border-b"><td class="py-1.5 text-slate-600 font-bold">استعمال شدہ یونٹس</td><td class="py-1.5 text-left font-mono font-bold">${meterData.consumedUnits.toFixed(2)}</td></tr><tr class="border-b"><td class="py-1.5 text-slate-600">فی یونٹ قیمت</td><td class="py-1.5 text-left font-mono">Rs. ${resultsData.perUnitRate.toFixed(3)}</td></tr></tbody></table><div class="mt-4 bg-indigo-50 p-3 rounded-lg text-center"><p class="text-sm sm:text-base text-slate-600">کُل قابلِ ادا رقم</p><p class="text-2xl sm:text-4xl font-bold text-indigo-700">Rs. ${meterData.amount.toFixed(0)}</p></div></div></div>`;
            }

            function generateHistorySmsText(record) {
                let text = `*بل کا خلاصہ*\n\n*مہینہ:* ${record.billingPeriod}\n\n*کُل بل:* Rs. ${record.totalBill.toFixed(0)}\n*کُل یونٹس:* ${record.totalMainUnits.toFixed(2)}\n*فی یونٹ قیمت:* Rs. ${record.perUnitRate.toFixed(3)}\n--------------------\n\n`;
                record.subMeters.forEach(meter => {
                    text += `*${meter.name}*\nیونٹس: ${meter.consumedUnits.toFixed(2)}\nرقم: Rs. ${meter.amount.toFixed(0)}\n\n`;
                });
                return text;
            }

            function generateHistoryHtml(record, forImage = false) {
                const containerStyle = forImage ? 'style="width: 550px;"' : '';
                return `<div class="bg-slate-100 p-2 urdu" ${containerStyle}><div class="w-full mx-auto bg-white p-4 rounded-lg shadow-lg"><h2 class="text-lg sm:text-xl font-bold text-center mb-1">بل کا خلاصہ</h2><p class="text-center text-slate-500 text-sm sm:text-base mb-3">${record.billingPeriod}</p><div class="p-2 bg-slate-50 rounded-lg urdu text-right space-y-1 mb-3 text-xs sm:text-sm"><div class="flex justify-between"><span class="text-slate-600">کُل بل:</span><span class="font-bold text-slate-800">Rs. ${record.totalBill.toFixed(2)}</span></div><div class="flex justify-between"><span class="text-slate-600">مین میٹر یونٹس:</span><span class="font-bold text-slate-800">${record.totalMainUnits.toFixed(2)}</span></div><div class="flex justify-between"><span class="text-slate-600">فی یونٹ قیمت:</span><span class="font-bold text-green-600">Rs. ${record.perUnitRate.toFixed(3)}</span></div></div><div class="overflow-x-auto"><table class="min-w-full bg-white text-xs sm:text-sm"><thead class="bg-slate-100"><tr class="urdu text-right"><th class="py-1.5 px-1">میٹر</th><th class="py-1.5 px-1 text-center">پچھلی ریڈنگ</th><th class="py-1.5 px-1 text-center">موجودہ ریڈنگ</th><th class="py-1.5 px-1 text-center">یونٹس</th><th class="py-1.5 px-1 text-center">رقم</th></tr></thead><tbody>${record.subMeters.map(meter => `<tr class="urdu text-right border-b border-slate-200"><td class="py-1.5 px-1">${meter.name}</td><td class="py-1.5 px-1 text-center">${meter.prevReading.toFixed(2)}</td><td class="py-1.5 px-1 text-center">${meter.currReading.toFixed(2)}</td><td class="py-1.5 px-1 text-center">${meter.consumedUnits.toFixed(2)}</td><td class="py-1.5 px-1 text-center font-bold text-indigo-600">Rs. ${meter.amount.toFixed(0)}</td></tr>`).join('')}</tbody></table></div></div></div>`;
            }

            function initializeModals() {
                dom.editModal.innerHTML = `<div class="bg-white rounded-xl shadow-xl p-5 w-full max-w-md urdu text-right m-4 text-sm"><h2 class="card-title text-lg sm:text-xl">میٹر میں ترمیم کریں</h2><div class="space-y-3"><div><label for="edit-meter-name" class="block font-medium text-slate-600">میٹر کا نام</label><input type="text" id="edit-meter-name" class="mt-1 block w-full rounded-md p-2 urdu urdu-input text-right border-slate-300"></div><div><label for="edit-meter-phone" class="block font-medium text-slate-600">واٹس ایپ نمبر</label><input type="tel" id="edit-meter-phone" class="mt-1 block w-full rounded-md p-2 latin-input text-right border-slate-300"></div></div><div class="mt-5 flex flex-col gap-2"><div class="flex gap-3"><button id="save-meter-edit-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md shadow hover:bg-indigo-700">محفوظ کریں</button><button class="close-modal-btn w-full bg-slate-200 text-slate-800 py-2 px-4 rounded-md hover:bg-slate-300">منسوخ کریں</button></div><button id="delete-meter-btn" class="text-xs text-red-600 hover:bg-red-50 p-2 rounded-lg">یہ میٹر حذف کریں</button></div></div>`;
                dom.editModal.querySelector('#save-meter-edit-btn').addEventListener('click', saveMeterEdit);
                dom.editModal.querySelector('#delete-meter-btn').addEventListener('click', deleteMeter);
                dom.editModal.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => dom.editModal.classList.remove('visible')));
                
                dom.historyModal.innerHTML = `<div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] urdu text-right m-4 flex flex-col sm:flex-row overflow-y-auto sm:overflow-hidden text-sm"><div id="history-list-panel" class="w-full sm:w-1/3 border-b sm:border-b-0 sm:border-r bg-slate-50 flex flex-col"><div class="p-3 border-b flex justify-between items-center"><h2 class="text-lg sm:text-xl font-bold text-slate-800">ہسٹری</h2><button class="close-modal-btn p-1 rounded-full hover:bg-slate-200 text-2xl">&times;</button></div><div id="history-list-container" class="flex-grow sm:overflow-y-auto"></div><div class="p-2 border-t"><button id="delete-all-history-btn" class="w-full text-xs bg-red-600 text-white py-1.5 px-3 rounded-md hover:bg-red-700">تمام ہسٹری حذف کریں</button></div></div><div id="history-details-container" class="w-full sm:w-2/3 p-3 sm:p-4 flex-grow flex flex-col"><div id="history-details-header" class="flex justify-between items-center flex-wrap"></div><div id="history-details-content" class="flex-grow overflow-y-auto mt-3"></div></div></div>`;
                dom.historyModal.querySelector('#delete-all-history-btn').addEventListener('click', deleteAllHistory);
                dom.historyModal.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => dom.historyModal.classList.remove('visible')));
                
                dom.historyModal.addEventListener('click', e => {
                    const item = e.target.closest('.history-list-item');
                    const delBtn = e.target.closest('.delete-history-item-btn');
                    const indPreviewBtn = e.target.closest('.history-ind-preview-btn');
                    const smsBtn = e.target.closest('.share-history-sms-btn');
                    const shareSummaryBtn = e.target.closest('.share-history-btn');
                    const previewSummaryBtn = e.target.closest('.preview-history-btn');
                    if (delBtn) {
                        e.stopPropagation();
                        deleteHistoryItem(delBtn.dataset.id);
                    } else if (indPreviewBtn) {
                        e.stopPropagation();
                        const record = getHistory().find(r => r.id == indPreviewBtn.dataset.recordId);
                        const meter = record.subMeters.find(m => m.id == indPreviewBtn.dataset.meterId);
                        if(record && meter) openPreviewModal(generateSingleBillHtml(record, meter), { isHistory: true, record, meter });
                    } else if (smsBtn) {
                        e.stopPropagation();
                        const record = getHistory().find(item => item.id == smsBtn.dataset.id);
                        if (record) {
                            const smsText = generateHistorySmsText(record);
                            if (navigator.share) {
                                navigator.share({ title: `بل کا خلاصہ - ${record.billingPeriod}`, text: smsText });
                            } else {
                                navigator.clipboard.writeText(smsText).then(() => showToast('خلاصہ کا متن کاپی ہو گیا۔'));
                            }
                        }
                    } else if (shareSummaryBtn) {
                        e.stopPropagation();
                        const recordData = getHistory().find(r => r.id == shareSummaryBtn.dataset.id);
                        if (recordData) shareBillAsImage(generateHistoryHtml(recordData, true), shareSummaryBtn, { isHistory: true, record: recordData });
                    } else if (previewSummaryBtn) {
                        e.stopPropagation();
                        const recordData = getHistory().find(r => r.id == previewSummaryBtn.dataset.id);
                        if (recordData) openPreviewModal(generateHistoryHtml(recordData), { isHistory: true, record: recordData });
                    } else if (item) {
                        dom.historyModal.querySelectorAll('.history-list-item').forEach(el => el.classList.remove('bg-indigo-100'));
                        item.classList.add('bg-indigo-100');
                        renderHistoryDetails(item.dataset.id);
                    }
                });
                
                dom.previewModal.innerHTML = `<div class="bg-white rounded-xl shadow-xl p-0 w-full max-w-4xl max-h-[90vh] urdu text-right m-0 flex flex-col overflow-hidden"><div class="flex-grow overflow-y-auto" id="preview-content"></div><div class="border-t p-2.5 text-center space-x-2 space-x-reverse"><button id="preview-share-btn" class="bg-green-600 text-white py-2 px-3 rounded-md shadow hover:bg-green-700 urdu text-xs">تصویر بھیجیں</button><button id="preview-share-text-btn" class="bg-yellow-600 text-white py-2 px-3 rounded-md shadow hover:bg-yellow-700 urdu text-xs">متن بھیجیں</button><button class="close-preview-btn bg-slate-200 text-slate-800 py-2 px-3 rounded-md hover:bg-slate-300 urdu text-xs">بند کریں</button></div></div>`;
                dom.previewModal.querySelector('.close-preview-btn').addEventListener('click', () => dom.previewModal.classList.remove('visible'));
                dom.previewModal.querySelector('#preview-share-btn').addEventListener('click', (e) => {
                    const fallbackData = JSON.parse(e.currentTarget.dataset.fallbackData);
                    const html = fallbackData.isHistory ? (fallbackData.meter ? generateSingleBillHtml(fallbackData.record, fallbackData.meter, true) : generateHistoryHtml(fallbackData.record, true)) : generateSingleBillHtml(fallbackData.results, fallbackData.meter, true);
                    shareBillAsImage(html, e.currentTarget, fallbackData);
                });
                dom.previewModal.querySelector('#preview-share-text-btn').addEventListener('click', (e) => {
                    const { isHistory, record, results, meter } = JSON.parse(e.currentTarget.dataset.fallbackData);
                    const smsText = isHistory ? (meter ? generateSingleBillSmsText(record, meter) : generateHistorySmsText(record)) : generateSingleBillSmsText(results, meter);
                    if (navigator.share) {
                        navigator.share({ title: `بل کی تفصیلات`, text: smsText });
                    } else {
                        navigator.clipboard.writeText(smsText).then(() => showToast('بل کا متن کاپی ہو گیا۔'));
                    }
                });
            }

            function openEditModal(meterId) {
                const meter = getMeters().find(m => m.id == meterId);
                if (!meter) return;
                document.getElementById('edit-meter-id').value = meter.id;
                document.getElementById('edit-meter-name').value = meter.name;
                document.getElementById('edit-meter-phone').value = meter.phone || '';
                dom.editModal.classList.add('visible');
            }

            function saveMeterEdit() {
                const id = document.getElementById('edit-meter-id').value;
                const name = document.getElementById('edit-meter-name').value.trim();
                const phone = document.getElementById('edit-meter-phone').value.trim();
                if (!name) return alert('میٹر کا نام خالی نہیں ہو سکتا۔');
                
                let meters = getMeters();
                if(meters.some(m => m.name === name && m.id != id)) {
                    return alert('اس نام کا میٹر پہلے سے موجود ہے۔');
                }
                
                const meterIndex = meters.findIndex(m => m.id == id);
                if(meterIndex !== -1) {
                    meters[meterIndex].name = name;
                    meters[meterIndex].phone = phone;
                    saveMeters(meters);
                    loadMeters();
                    dom.editModal.classList.remove('visible');
                    showToast('تبدیلیاں محفوظ ہو گئیں۔');
                }
            }

            function deleteMeter() {
                const meterId = document.getElementById('edit-meter-id').value;
                const meterToDelete = getMeters().find(m => m.id == meterId);
                if (meterToDelete && confirm(`کیا آپ واقعی میٹر "${meterToDelete.name}" کو حذف کرنا چاہتے ہیں؟`)) {
                    saveMeters(getMeters().filter(m => m.id != meterId));
                    loadMeters();
                    dom.editModal.classList.remove('visible');
                    showToast('میٹر حذف کر دیا گیا۔');
                }
            }

            function openHistoryModal() {
                renderHistoryList();
                dom.historyModal.classList.add('visible');
            }

            function renderHistoryList() {
                const history = getHistory();
                const container = dom.historyModal.querySelector('#history-list-container');
                if (history.length === 0) {
                    container.innerHTML = `<p class="p-4 text-center text-slate-500 urdu">کوئی ہسٹری نہیں۔</p>`;
                    dom.historyModal.querySelector('#history-details-content').innerHTML = `<p class="text-center text-slate-500 urdu mt-10">کوئی ہسٹری موجود نہیں۔</p>`;
                    dom.historyModal.querySelector('#history-details-header').innerHTML = '';
                    return;
                }
                container.innerHTML = history.map(item => `<div class="history-list-item p-2.5 border-b hover:bg-indigo-50 cursor-pointer" data-id="${item.id}"><p class="font-semibold text-slate-800 urdu">${item.billingPeriod}</p><p class="text-xs text-slate-500" style="direction: ltr;">${new Date(item.calculationDate).toLocaleDateString('ur-PK')}</p></div>`).join('');
                
                const firstItem = container.querySelector('.history-list-item');
                if (firstItem) {
                    firstItem.classList.add('bg-indigo-100');
                    renderHistoryDetails(firstItem.dataset.id);
                }
            }

            function renderHistoryDetails(id) {
                const record = getHistory().find(item => item.id == id);
                if (!record) return;
                
                const meterRows = record.subMeters.map(meter => `
                    <tr class="urdu text-right border-b border-slate-200">
                        <td class="py-2 px-2">${meter.name}</td>
                        <td class="py-2 px-2 text-center">${meter.consumedUnits.toFixed(2)}</td>
                        <td class="py-2 px-2 text-center font-bold text-indigo-600">Rs. ${meter.amount.toFixed(0)}</td>
                        <td class="py-2 px-2 text-center">
                            <button class="history-ind-preview-btn bg-indigo-100 text-indigo-700 text-xs py-1 px-2 rounded-full hover:bg-indigo-200 urdu" data-record-id="${record.id}" data-meter-id="${meter.id}">
                                پریویو
                            </button>
                        </td>
                    </tr>`).join('');
                    
                dom.historyModal.querySelector('#history-details-header').innerHTML = `<h3 class="text-lg sm:text-xl font-bold text-slate-800">${record.billingPeriod}</h3><div class="flex items-center gap-1 sm:gap-2 flex-wrap justify-end"><button class="share-history-sms-btn bg-yellow-100 text-yellow-800 text-xs py-1 px-2 rounded-full hover:bg-yellow-200 urdu" data-id="${id}">متن</button><button class="share-history-btn bg-green-100 text-green-700 text-xs py-1 px-2 rounded-full hover:bg-green-200 urdu" data-id="${id}">خلاصہ</button><button class="preview-history-btn bg-blue-100 text-blue-700 text-xs py-1 px-2 rounded-full hover:bg-blue-200 urdu" data-id="${id}">پریویو</button><button class="delete-history-item-btn text-red-500 hover:text-red-700 p-1" data-id="${id}" title="حذف کریں">&times;</button></div>`;
                dom.historyModal.querySelector('#history-details-content').innerHTML = `<div class="p-3 bg-slate-50 rounded-lg urdu text-right space-y-2 mb-4 text-xs"><div class="flex justify-between"><span class="text-slate-600">کُل بل:</span><span class="font-bold text-slate-800">Rs. ${record.totalBill.toFixed(2)}</span></div><div class="flex justify-between"><span class="text-slate-600">مین میٹر یونٹس:</span><span class="font-bold text-slate-800">${record.totalMainUnits.toFixed(2)}</span></div><div class="flex justify-between"><span class="text-slate-600">فی یونٹ قیمت:</span><span class="font-bold text-green-600">Rs. ${record.perUnitRate.toFixed(3)}</span></div></div><div class="overflow-x-auto"><table class="min-w-full bg-white text-xs sm:text-sm"><thead class="bg-slate-100"><tr class="urdu text-right"><th class="py-2 px-2">میٹر</th><th class="py-2 px-2">یونٹس</th><th class="py-2 px-2">رقم</th><th class="py-2 px-2">کارروائی</th></tr></thead><tbody>${meterRows}</tbody></table></div>`;
            }

            function deleteAllHistory() {
                if (confirm('کیا آپ واقعی تمام ہسٹری حذف کرنا چاہتے ہیں؟')) {
                    saveHistory([]);
                    renderHistoryList();
                    showToast('تمام ہسٹری حذف کر دی گئی۔');
                }
            }

            function deleteHistoryItem(id) {
                if (confirm('کیا آپ واقعی اس ریکارڈ کو حذف کرنا چاہتے ہیں؟')) {
                    saveHistory(getHistory().filter(item => item.id != id));
                    renderHistoryList();
                    showToast('ریکارڈ حذف کر دیا گیا۔');
                }
            }

            function openPreviewModal(htmlContent, fallbackData) {
                dom.previewModal.querySelector('#preview-content').innerHTML = htmlContent;
                dom.previewModal.querySelector('#preview-share-btn').dataset.fallbackData = JSON.stringify(fallbackData);
                dom.previewModal.querySelector('#preview-share-text-btn').dataset.fallbackData = JSON.stringify(fallbackData);
                dom.previewModal.classList.add('visible');
            }

            initializeApp();
        });
    </script>

</body>
</html>
